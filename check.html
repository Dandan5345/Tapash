<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Tapash - בדיקות עמדות אש</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>
  <!-- html5-qrcode לסריקת QR -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <!-- אייקונים -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      background: linear-gradient(120deg, #4fd1c5 0%, #0077b6 100%);
      font-family: 'Heebo', 'Segoe UI', Arial, sans-serif;
      min-height: 100vh; margin: 0; padding: 0;
    }
    .container {
      max-width: 620px; margin: 56px auto 0 auto; background: rgba(255,255,255,0.98);
      border-radius: 18px; box-shadow: 0 12px 46px 0 rgba(20,80,150,0.17);
      padding: 38px 27px 36px 27px;
    }
    h1 {
      text-align: center;
      color: #0077b6;
      font-size: 2.1rem;
      margin-bottom: 32px;
      letter-spacing: 1px;
      font-weight: 700;
      text-shadow: 0 2px 13px #d9fbf1a0;
    }
    .btn-main {
      width: 100%;
      background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
      color: #11477a;
      border: none;
      border-radius: 11px;
      font-size: 1.25em;
      font-weight: 700;
      padding: 20px 0;
      margin: 0 auto 28px auto;
      display: block;
      transition: 0.15s;
      box-shadow: 0 5px 17px 0 #25c6a322;
      cursor: pointer;
      letter-spacing: 1px;
    }
    .btn-main:active { transform: scale(0.99);}
    .stations-table {
      width: 100%;
      margin-top: 16px;
      border-collapse: separate;
      border-spacing: 0 13px;
    }
    .stations-table th, .stations-table td {
      text-align: center;
      font-size: 1.06em;
      padding: 15px 6px;
      background: #f7fcfe;
      border-radius: 9px;
      border: none;
      box-shadow: 0 2px 12px #46e7e21a;
    }
    .stations-table th { background: none; color: #0077b6; font-weight: 700; font-size: 1.1em; }
    .station-action-btn {
      background: linear-gradient(90deg, #0093e9 0%, #80d0c7 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 9px 13px;
      font-size: 1.13em;
      font-weight: 600;
      cursor: pointer;
      transition: 0.13s;
      box-shadow: 0 1.5px 7px 0 #77c7ef21;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .station-action-btn.edit {
      background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
      color: #424242;
    }
    .station-action-btn:active { transform: scale(0.97);}
    .status-chip {
      font-weight: 700; font-size: 1.06em; padding: 7px 15px; border-radius: 22px;
      display: inline-flex; align-items: center; gap: 6px;
      margin: 0 6px;
    }
    .status-ok {
      background: #defde0; color: #27b254; border: 1.4px solid #21b56e;
    }
    .status-bad {
      background: #ffe7df; color: #ec5050; border: 1.4px solid #d64545;
    }
    .status-note {
      background: #e2f0fb; color: #1976d2; border: 1.4px solid #31a2d9;
    }
    .modal-bg { display: none; position: fixed; top:0; right:0; left:0; bottom:0; background: rgba(40,74,100,0.19); z-index: 999; align-items: center; justify-content: center;}
    .modal-bg.active { display: flex; }
    .modal { background: #fff; border-radius: 16px; padding: 32px 24px 24px 24px; min-width: 290px; max-width: 99vw; box-shadow: 0 3px 30px #176be244;}
    .modal h3 { text-align: center; color: #0077b6; font-size: 1.2em;}
    .modal label { margin-top: 11px; display: block;}
    .modal input, .modal select, .modal textarea {
      width: 100%; margin-top: 4px; margin-bottom: 11px; padding: 9px;
      border-radius: 6px; border: 1.2px solid #b5e4e3; font-size: 1.06em;
      background: #f7fcfe;
    }
    .modal .btns { margin-top: 16px; text-align: center;}
    .modal .btns button { margin: 0 7px;}
    #qr-modal { z-index: 2000; }
    #qr-reader { margin: 0 auto; width: 270px;}
    #qr-error { color: #a61d1d; text-align: center; font-size: 1.09em; margin: 8px 0 0 0;}
    @media (max-width: 630px) {
      .container { max-width: 99vw; padding: 12vw 2vw 7vw 2vw;}
      h1 { font-size: 1.29rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tapash <span style="font-size:0.7em;color:#43e97b">| ניהול בדיקות אש</span></h1>
    <button id="start-btn" class="btn-main"><i class="fa-solid fa-play"></i> התחל בדיקה שבועית</button>
    <div id="stationsBlock" style="display:none;">
      <table class="stations-table" id="stationsTable">
        <thead>
          <tr>
            <th>עמדה</th>
            <th>סטטוס</th>
            <th>פעולה</th>
          </tr>
        </thead>
        <tbody id="stationsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- מודל לטופס בדיקה -->
  <div class="modal-bg" id="modalBG">
    <div class="modal">
      <form id="modalForm">
        <h3 id="modalTitle"></h3>
        <label>תאריך:</label>
        <input type="text" id="modalDate" readonly>
        <label>שם קב"ט:</label>
        <input type="text" id="modalInspector" required>
        <label>עמדה:</label>
        <input type="text" id="modalStation" readonly>
        <label>תקינות:</label>
        <select id="modalStatus">
          <option value="כן">כן</option>
          <option value="לא">לא</option>
        </select>
        <label>הערות:</label>
        <textarea id="modalNotes" rows="2"></textarea>
        <div class="btns">
          <button type="submit" style="background:#21c97a;color:#fff;">שלח</button>
          <button type="button" onclick="closeModal()">ביטול</button>
        </div>
      </form>
    </div>
  </div>

  <!-- מודל סריקת QR -->
  <div class="modal-bg" id="qr-modal">
    <div class="modal" style="min-width:300px;max-width:99vw;">
      <h3 id="qr-title">סרוק את הברקוד של העמדה</h3>
      <div id="qr-reader"></div>
      <div id="qr-error"></div>
      <div class="btns">
        <button onclick="closeQRModal()">ביטול</button>
      </div>
    </div>
  </div>

  <script type="module">
    // --- קונפיג Firebase שלך ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, setDoc, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAuflYG4eTuvFO4ixRclUlZ_V1yd-k22L4",
      authDomain: "tapashe-31391.firebaseapp.com",
      projectId: "tapashe-31391",
      storageBucket: "tapashe-31391.firebasestorage.app",
      messagingSenderId: "619276973853",
      appId: "1:619276973853:web:ea6e5cf6a22968b62e93f4",
      measurementId: "G-ZLZT6TBPG3"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // עמדות דמו (אפשר להרחיב לכמה שתרצה)
    const stations = [
      { name: "לובי", barcode: "TAPASH-LOBBY-2024" },
      { name: "חנייה", barcode: "TAPASH-PARKING-2024" }
    ];
    // לשימוש פנימי:
    let editingDocId = null;
    let currentScanStation = null;
    let html5Qr = null;

    // הצגת טבלה רק אחרי "התחל בדיקה שבועית"
    document.getElementById('start-btn').onclick = () => {
      document.getElementById('stationsBlock').style.display = 'block';
      renderStationsTable();
      document.getElementById('start-btn').style.display = 'none';
    };

    // בונה טבלה דינמית של כל העמדות
    async function renderStationsTable() {
      const tbody = document.getElementById('stationsBody');
      tbody.innerHTML = "";
      const today = new Date().toISOString().split('T')[0];

      // שליפת הבדיקות שכבר בוצעו
      const checksSnap = await getDocs(query(collection(db, "fire_checks"), where("date", "==", today)));
      const checks = {};
      checksSnap.forEach(docSnap => {
        const d = docSnap.data();
        checks[d.station] = { ...d, docId: docSnap.id };
      });

      stations.forEach(station => {
        const check = checks[station.name];
        let statusCell = "";
        let actionBtn = "";

        if (!check) {
          // טרם בוצעה בדיקה – כפתור סריקת ברקוד בלבד
          statusCell = `<span class="status-chip status-note"><i class="fa fa-clock"></i> לא בוצע</span>`;
          actionBtn = `<button class="station-action-btn scan" data-station="${station.name}"><i class="fa-solid fa-qrcode"></i> סרוק ברקוד</button>`;
        } else {
          // כבר יש בדיקה – מציגים סטטוס ומאפשרים עריכה
          if (check.status === "כן") {
            statusCell = `<span class="status-chip status-ok"><i class="fa-solid fa-circle-check"></i> תקין</span>`;
          } else {
            statusCell = `<span class="status-chip status-bad"><i class="fa-solid fa-triangle-exclamation"></i> לא תקין</span>`;
          }
          if (check.notes && check.notes.trim() !== "") {
            statusCell += `<span class="status-chip status-note"><i class="fa-regular fa-comment-dots"></i> הערות</span>`;
          }
          actionBtn = `<button class="station-action-btn edit" data-docid="${check.docId}"><i class="fa-solid fa-pen"></i> ערוך</button>`;
        }

        tbody.innerHTML += `
          <tr>
            <td>${station.name}</td>
            <td>${statusCell}</td>
            <td>${actionBtn}</td>
          </tr>
        `;
      });

      // מאזין מחדש לכפתורים:
      document.querySelectorAll('.station-action-btn.scan').forEach(btn => {
        btn.onclick = function() {
          const stationName = btn.dataset.station;
          openQRModal(stationName);
        }
      });
      document.querySelectorAll('.station-action-btn.edit').forEach(btn => {
        btn.onclick = async function() {
          const docId = btn.dataset.docid;
          // שלוף את הדאטה הקיים לעריכה
          const checksSnap = await getDocs(query(collection(db, "fire_checks"), where("__name__", "==", docId)));
          checksSnap.forEach(d => openModal(d.data().station, docId, d.data()));
        }
      });
    }

    // מודל סריקת QR – תומך בבדיקה שהברקוד שייך לעמדה הזו בלבד
    function openQRModal(stationName) {
      currentScanStation = stationName;
      document.getElementById('qr-modal').classList.add('active');
      document.getElementById('qr-error').innerText = "";
      document.getElementById('qr-title').innerText = `סרוק את הברקוד של העמדה: ${stationName}`;
      if (!html5Qr) {
        html5Qr = new Html5Qrcode("qr-reader");
      } else {
        html5Qr.stop().then(()=>{});
      }
      html5Qr.start(
        { facingMode: "environment" },
        { fps: 15, qrbox: 220 },
        (decodedText) => {
          const stationObj = stations.find(s => s.name === currentScanStation);
          if (stationObj && decodedText === stationObj.barcode) {
            html5Qr.stop().then(()=>{});
            document.getElementById('qr-modal').classList.remove('active');
            openModal(stationObj.name);
          } else {
            document.getElementById('qr-error').innerText = "❌ זה לא הברקוד הנכון לעמדה הזו! נסה שוב.";
          }
        },
        (errorMessage) => { /* לא להציג שגיאות קטנות */ }
      ).catch(err => {
        document.getElementById('qr-error').innerText = "לא ניתן להפעיל מצלמה. אפשר לאשר הרשאה או לנסות דפדפן אחר.";
      });
    }
    window.closeQRModal = function() {
      document.getElementById('qr-modal').classList.remove('active');
      if (html5Qr) html5Qr.stop().then(()=>{});
    }

    // מודל בדיקה
    function openModal(station, docId=null, editData=null) {
      document.getElementById('modalBG').classList.add('active');
      document.getElementById('modalTitle').innerText = "בדיקת עמדה: " + station;
      document.getElementById('modalDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('modalStation').value = station;
      document.getElementById('modalInspector').value = editData ? editData.inspector : "";
      document.getElementById('modalStatus').value = editData ? editData.status : "כן";
      document.getElementById('modalNotes').value = editData ? editData.notes : "";
      editingDocId = docId;
    }
    function closeModal() {
      document.getElementById('modalBG').classList.remove('active');
      editingDocId = null;
      setTimeout(()=>{renderStationsTable();}, 100);
    }

    // שליחת טופס בדיקה
    document.getElementById('modalForm').onsubmit = async function(e) {
      e.preventDefault();
      const data = {
        date: document.getElementById('modalDate').value,
        inspector: document.getElementById('modalInspector').value,
        station: document.getElementById('modalStation').value,
        status: document.getElementById('modalStatus').value,
        notes: document.getElementById('modalNotes').value,
        timestamp: Date.now()
      };
      if (editingDocId) {
        await updateDoc(doc(db, "fire_checks", editingDocId), data);
      } else {
        await addDoc(collection(db, "fire_checks"), data);
      }
      closeModal();
      renderStationsTable();
    };

    // בזמן טעינה – רק טבלה ריקה (עד "התחל")
    document.getElementById('stationsBody').innerHTML = "";

  </script>
</body>
</html>